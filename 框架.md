本文章重点在于[微信小程序框架](https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/app.html)的学习笔记。并且在实际项目中运用巩固

## 目录结构
创建一个普通微信小程序项目，会有以下几个目录结构：
```shell  
|—— pages // 分页
|   |—— index
|       |—— index.js    // 分页逻辑
|       |—— index.json  // 分页配置
|       |—— index.wxml  // 分页视图层
|       |—— index.wxss  // 分页样式
|   |—— logs
|       |—— logs.js
|       |—— logs.json
|       |—— logs.wxml
|       |—— logs.wxss
|—— utils
|   |—— util.js
|—— app.js // 全局逻辑，注册小程序
|—— app.json // 全局配置
|—— app.wxss // 全局样式
|—— project.config.json // 工具配置文件
```

## 配置
### 全局配置
详情请看[app.json 配置项列表](https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE)
常用配置：
- **pages：**页面路径列表,需要将所有的页面路径写进去。数组模式
- **window：**全局的默认窗口表现，主要用于设置小程序的状态栏、导航条、标题、窗口背景色。
{% asset_img config.jpg %}
- **tabBar：**底部 tab 栏的表现，当小程序是一个多tab应用时配置相关信息。
- **networkTimeout：**各类网络请求的超时时间，单位均为毫秒。
- **debug：**开发者工具中开启 debug 模式,Boolean
- **navigateToMiniProgramAppIdList：**使用 wx.navigateToMiniProgram 接口跳转到其他小程序时，需要先在配置文件中声明需要跳转的小程序 appId 列表，最多允许填写 10 个
- **permission：**小程序接口权限相关设置。字段类型为 Object

### 页面配置
页面配置会覆盖app.json里面的内容，详情请看[页面配置项列表]{https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#%E9%A1%B5%E9%9D%A2%E9%85%8D%E7%BD%AE}

## 逻辑层
逻辑层将数据进行处理后发送给视图层，同时接受视图层的事件反馈。开发者写的所有代码最终将会打包成一份 JavaScript 文件，并在小程序启动的时候运行，**直到小程序销毁**。这一行为类似 ServiceWorker，所以逻辑层也称之为 App Service。

### 注册App(Object)
App() 函数用来注册一个小程序。接受一个 Object 参数，其指定小程序的生命周期回调等。App() 必须在 **app.js** 中调用，必须调用且只能调用一次。不然会出现无法预期的后果。
```bash
App({
  // 小程序初始化完成时（全局只触发一次）
  onLaunch(options) {
    // Do something initial when launch.
  },
  // 小程序启动，或从后台进入前台显示时
  onShow(options) {
    // Do something when show.
  },
  // 小程序从前台进入后台时
  onHide() {
    // Do something when hide.
  },
  // 小程序发生脚本错误，或者 api 调用失败时触发，会带上错误信息
  onError(msg) {
    console.log(msg)
  },
  // 或者这种写法。
  // 小程序要打开的页面不存在时触发，会带上页面信息回调该函数
  onPageNotFound:function(){
    // Do something when page not found.
  },
  globalData: 'I am global data'
})
```
**前台、后台定义**： 当用户点击右上角关闭，或者按了设备 Home 键离开微信，小程序并没有直接销毁，而是进入了后台；当再次进入微信或再次打开小程序，又会从后台进入前台。需要注意的是：只有当小程序进入后台一定时间，或者系统资源占用过高，才会被真正的销毁。
>关闭小程序：当用户从扫一扫、转发等入口（场景值为1007, 1008, 1011, 1025）进入小程序，且没有置顶小程序的情况下退出，小程序会被销毁。

- onLaunch(Object)：参数可以使用 wx.getLaunchOptionsSync 获取，参数与 wx.getLaunchOptionsSync 一致
- onShow(Object)：可以使用 wx.onAppShow 绑定监听，参数与 wx.onAppShow 一致
- onHide()：使用 wx.onAppHide 绑定监听
- onError(String error)：使用 wx.onError 绑定监听，参数与 wx.onError 一致
- onPageNotFound(Object)：使用 wx.onPageNotFound 绑定监听，参数与 wx.onPageNotFound 一致
```bash
App({
  onPageNotFound(res) {
    wx.redirectTo({
      url: 'pages/...'
    }) // 如果是 tabbar 页面，请使用 wx.switchTab
  }
})
```
#### getApp(Object)
全局的 getApp() 函数可以用来获取到小程序 App 实例。
>不要在定义于 App() 内的函数中调用 getApp() ，使用 this 就可以拿到 app 实例。通过 getApp() 获取实例之后，不要私自调用生命周期函数。

### 场景值
- 对于小程序，可以在 App 的 onLaunch 和 onShow，或wx.getLaunchOptionsSync 中获取上述场景值。
- 对于小游戏，可以在 wx.getLaunchOptionsSync 和 wx.onShow 中获取上述场景值

>由于Android系统限制，目前还无法获取到按 Home 键退出到桌面，然后从桌面再次进小程序的场景值，对于这种情况，会保留上一次的场景值。

### 注册页面
#### Page(Object) 构造器
Page(Object) 函数用来注册一个页面。接受一个 Object 类型参数，其指定页面的初始数据、生命周期回调、事件处理函数等。
- data：初始数据
页面加载时，data 将会以JSON字符串的形式由逻辑层传至渲染层，因此data中的数据必须是可以转成JSON的类型：字符串，数字，布尔值，对象，数组。渲染层可以通过 WXML 对数据进行绑定。
- onLoad：生命周期回调—监听页面加载，一个页面只会调用一次。参数为Object类型--打开当前页面路径中的参数
可以在 onLoad 的参数中获取打开当前页面路径中的参数。
- onShow：生命周期回调—监听页面显示
- onReady：生命周期回调—监听页面初次渲染完成，一个页面只会调用一次
- onHide：生命周期回调—监听页面隐藏，如 navigateTo 或底部 tab 切换到其他页面，小程序切入后台等
- onUnload：生命周期回调—监听页面卸载，如redirectTo或navigateBack到其他页面时
- onPullDownRefresh：监听用户下拉动作
>需要在app.json的window选项中或页面配置中开启enablePullDownRefresh。可以通过wx.startPullDownRefresh触发下拉刷新，调用后触发下拉刷新动画，效果与用户手动下拉刷新一致。当处理完数据刷新后，wx.stopPullDownRefresh可以停止当前页面的下拉刷新。
- onReachBottom：页面上拉触底事件的处理函数,在触发距离内滑动期间，本事件只会被触发一次。
>请只在需要的时候才在 page 中定义此方法，不要定义空方法。以减少不必要的事件派发对渲染层-逻辑层通信的影响。 注 意：请避免在 onPageScroll 中过于频繁的执行 setData 等引起逻辑层-渲染层通信的操作。尤其是每次传输大量数据，会影响通信耗时。
- onShareAppMessage：用户点击右上角转发，</button> 组件 open-type="share"或右上角菜单“转发”按钮。参数为Object类型，有from(转发时间来源：button/menu)、target(取决于from:触发该事件的button/undefined)、webViewUrl(页面中包含</web-view>组件时，返回当前</web-view>的url)。
  >只有定义了此事件处理函数，右上角菜单才会显示“转发”按钮

  该事件需要返回一个Object，用于定义转发内容。内容如下：
  - title:转发标题
  - path:转发路径,必须是以 / 开头的完整路径
  - imageUrl:自定义图片路径，可以是本地文件路径、代码包文件路径或者网络图片路径。支持PNG及JPG。显示图片长宽比是 5:4
  ```bash
  Page({
    onShareAppMessage(res) {
      if (res.from === 'button') {
        // 来自页面内转发按钮
        console.log(res.target)
      }
      return {
        title: '自定义转发标题',
        path: '/page/user?id=123'
      }
    }
  })
  ```
- onPageScroll：页面滚动触发事件的处理函数，参数为Number类型--页面在垂直方向已滚动的距离（单位px）
- onResize：页面尺寸改变时触发
- onTabItemTap：当前是 tab 页时，点击 tab 时触发。参数为Object类型，属性为index(String,被点击tabItem的序号，从0开始)、pagePath、text(被点击tabItem的按钮文字)

#### 组件事件处理函数(bindtap)
在渲染层的组件中加入事件绑定，当事件被触发时，就会执行 Page 中定义的事件处理函数。
```bash
<view bindtap="viewTap">click me</view>

Page({
  viewTap() {
    console.log('view tap')
  }
})
```

#### Page.route
当前页面的路径，类型为String
```bash
Page({
  onShow() {
    console.log(this.route)
  }
})
```

#### Page.prototype.setData(Object data, Function callback)
setData 函数用于将数据从逻辑层发送到视图层（异步），同时改变对应的 this.data 的值（同步）
- 直接修改 this.data 而不调用 this.setData 是无法改变页面的状态的，还会造成数据不一致。
- 仅支持设置可 JSON 化的数据。
- 单次设置的数据不能超过1024kB，请尽量避免一次设置过多的数据。
- 请不要把 data 中任何一项的 value 设为 undefined ，否则这一项将不被设置并可能遗留一些潜在问题。

#### 生命周期
{% asset_img mina-lifecycle.png %}

### 路由
### 页面栈
其表现形式:

| 路由方式 | 页面栈表现 | 触发时机 | 路由前页面 | 路由后页面 |
| ---- | ---- | ----| ---- |----|
|初始化|新页面入栈|小程序打开的第一个页面|null |onLoad, onShow|
|打开新页面|新页面入栈|调用 API wx.navigateTo 或使用组件 </navigator open-type="navigateTo"/>|onHide|onLoad, onShow|
|页面重定向|当前页面出栈，新页面入栈|调用 API wx.redirectTo 或使用组件 </navigator open-type="redirectTo"/>|onUnload|onLoad, onShow|
|页面返回|页面不断出栈，直到目标返回页|调用 API wx.navigateBack 或使用组件</navigator open-type="navigateBack">或用户按左上角返回按钮|onUnload|onLoad, onShow|
|Tab切换|页面全部出栈，只留下新的 Tab 页面|调用 API wx.switchTab 或使用组件 </navigator open-type="switchTab"/> 或用户切换 Tab|null |多种情况|
|重加载|页面全部出栈，只留下新的页面|调用 API wx.reLaunch 或使用组件 </navigator open-type="reLaunch"/>|onUnload|onLoad, onShow|

#### Tab 切换对应的生命周期
以A、B页面为Tabbar页面，C是从A页面打开的页面，D页面是从C页面打开的页面为例：
{% asset_img tabBar.png %}
{% asset_img A-C-D.png %}
{% asset_img A-C.png %}
{% asset_img reLaunch.png %}
总结：**只要不在栈内的页面，进入时都会触发onload和onReady**
- navigateTo, redirectTo 只能打开非tabBar页面。navigateTo不会销毁原页面，redirectTo会销毁原页面
- switchTab 只能打开 tabBar 页面。
- reLaunch 可以打开任意页面。此时页面全部销毁，然后重新加载页面
- 页面底部的 tabBar 由页面决定，即只要是定义为 tabBar 的页面，底部都有 tabBar。
- 调用页面路由带的参数可以在目标页面的onLoad中获取。


#### getCurrentPages()
用于获取当前页面栈的实例，以数组形式按栈的顺序给出，第一个元素为首页，最后一个元素为当前页面。
- 不要尝试修改页面栈，会导致路由以及页面状态错误。
- 不要在 App.onLaunch 的时候调用 getCurrentPages()，此时 page 还没有生成。

### 模块化
在 JavaScript 文件中声明的变量和函数只在该文件中有效；不同的文件中可以声明相同名字的变量和函数，不会互相影响。通过全局函数 getApp() 可以获取全局的应用实例，如果需要全局的数据可以在 App() 中设置。
#### 模块化
可以将一些公共的代码抽离成为一个单独的 js 文件，作为一个模块。模块只有通过 module.exports 或者 exports 才能对外暴露接口。
>小程序目前不支持直接引入 node_modules , 开发者需要使用到 node_modules 时候建议拷贝出相关的代码到小程序的目录中或者使用小程序支持的 npm 功能

#### module.exports 和 exports的区别
exports = module.exports = {};即exports是module.exports的一个引用
```bash
// common.js
function sayHello(name) {
  console.log(`Hello ${name} !`)
}
function sayGoodbye(name) {
  console.log(`Goodbye ${name} !`)
}
module.exports.sayHello = sayHello
exports.sayGoodbye = sayGoodbye;
exports = 'Silvia';

// 其他文件引入
const common = require('../../js/common.js');
console.log(common); // {sayHello: ƒ, sayGoodbye: ƒ}
```

### API
这里不做介绍，后面会有相关文章详细介绍

## 视图层
组件(Component)是视图的基本组成单元
### WXML
#### 数据绑定
数据绑定使用 Mustache 语法（双大括号）将变量包起来，可以作用于:
- 内容
```bash
<view>{{ message }}</view>
```
- 组件属性(需要在双引号之内),
```bash
<view id="item-{{id}}"></view>
```
- 控制属性(需要在双引号之内),eg：
```bash
<view wx:if="{{condition}}"></view>
```
- 关键字(需要在双引号之内),eg：
  ```bash
  <checkbox checked="{{false}}"></checkbox>
  ```
  >不要直接写 checked="false"，其计算结果是一个字符串，转成 boolean 类型后代表真值
- 运算,可以在**双大括号**内进行简单的运算。支持三元运算、算数运算、逻辑判断、字符串运算、数据路径运算、组合
```bash
Page({
  data: {
    zero: 0,
    a:1,
    b:2,
    obj1: {
      a: 1,
      b: 2
    },
    obj2: {
      c: 3,
      d: 4
    }
  }
})
// 数组,最终为[]
<view wx:for="{{[zero, 1, 2, 3, 4]}}">{{item}}</view> 
// 对象
<template is="objectCombine" data="{{for: a, bar: b}}"></template>
// 扩展运算符 ... 来将一个对象展开
<template is="objectCombine" data="{{...obj1, ...obj2, e: 5}}"></template>
// 如果对象的 key 和 value 相同，也可以间接地表达。
<template is="objectCombine" data="{{a, b}}"></template>
// 上述方式可以随意组合，但是如有存在变量名相同的情况，后边的会覆盖前面
// 花括号和引号之间如果有空格，将最终被解析成为字符串
<view wx:for="{{[1,2,3]}} ">
  {{item}}
</view>
// 等同于
<view wx:for="{{[1,2,3] + ' '}}">
  {{item}}
</view>
```

#### 列表渲染